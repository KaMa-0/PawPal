// Das ist deine Konfiguration
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums (Auswahlmöglichkeiten) ---

enum BookingStatus {
  PENDING
  ACCEPTED
  DECLINED
  COMPLETED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// --- Deine Tabellen ---

model User {
  userId          Int      @id @default(autoincrement()) // PK
  email           String   @unique
  passwordHash    String
  registrationDate DateTime @default(now())

  // Relationen (Ein User kann EINE dieser Rollen haben)
  petOwner        PetOwner?
  petSitter       PetSitter?
  admin           Admin?

  // Profilbilder (Ein User kann mehrere Bilder haben)
  profileImages   ProfileImage[]
}

model PetOwner {
  userId    Int     @id // PK und FK zugleich
  user      User    @relation(fields: [userId], references: [userId])
  username  String
  aboutText String? // Das '?' bedeutet optional (kann leer sein)

  // Relationen
  bookings      Booking[]
  favorites     Favorite[]
  petTypes      OwnerPetType[]
}

model PetSitter {
  userId        Int     @id
  user          User    @relation(fields: [userId], references: [userId])
  username      String
  aboutText     String?
  location      String  // HINZUGEFÜGT für die Suchfunktion!
  averageRating Float   @default(0.0)

  // Relationen
  bookings              Booking[]
  favorites             Favorite[]     @relation("SitterFavorites")
  petTypes              SitterPetType[]
  certificationRequests CertificationRequest[]
}

model Admin {
  userId Int  @id
  user   User @relation(fields: [userId], references: [userId])

  // Relationen
  processedRequests CertificationRequest[]
}

model Booking {
  bookingId   Int           @id @default(autoincrement())
  ownerId     Int
  sitterId    Int
  status      BookingStatus @default(PENDING)
  requestDate DateTime      @default(now())
  details     String?       @db.Text // @db.Text erlaubt sehr lange Texte

  // Verbindungen
  owner       PetOwner      @relation(fields: [ownerId], references: [userId])
  sitter      PetSitter     @relation(fields: [sitterId], references: [userId])

  review      Review?       // Ein Booking hat maximal ein Review
}

model Review {
  reviewId  Int     @id @default(autoincrement())
  bookingId Int     @unique // Wichtig: Eine Review pro Booking
  rating    Int
  text      String? @db.Text

  booking   Booking @relation(fields: [bookingId], references: [bookingId])
}

model CertificationRequest {
  requestId      Int           @id @default(autoincrement())
  sitterId       Int
  adminId        Int?          // Kann null sein, solange noch kein Admin es bearbeitet hat
  status         RequestStatus @default(PENDING)
  submissionDate DateTime      @default(now())

  sitter         PetSitter     @relation(fields: [sitterId], references: [userId])
  admin          Admin?        @relation(fields: [adminId], references: [userId])
}

model PetType {
  petTypeId Int             @id @default(autoincrement())
  name      String          @unique

  // Relationen
  owners    OwnerPetType[]
  sitters   SitterPetType[]
}

// --- Join Tabellen (Verknüpfungstabellen) ---

model OwnerPetType {
  ownerId   Int
  petTypeId Int

  owner     PetOwner @relation(fields: [ownerId], references: [userId])
  petType   PetType  @relation(fields: [petTypeId], references: [petTypeId])

  @@id([ownerId, petTypeId]) // Zusammengesetzter Primärschlüssel
}

model SitterPetType {
  sitterId  Int
  petTypeId Int

  sitter    PetSitter @relation(fields: [sitterId], references: [userId])
  petType   PetType   @relation(fields: [petTypeId], references: [petTypeId])

  @@id([sitterId, petTypeId])
}

model Favorite {
  ownerId  Int
  sitterId Int

  owner    PetOwner  @relation(fields: [ownerId], references: [userId])
  sitter   PetSitter @relation("SitterFavorites", fields: [sitterId], references: [userId])

  @@id([ownerId, sitterId])
}

model ProfileImage {
  imageId  Int    @id @default(autoincrement())
  userId   Int
  imageUrl String

  user     User   @relation(fields: [userId], references: [userId])
}